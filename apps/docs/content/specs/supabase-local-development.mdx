# Supabase Local Development

Complete guide to Supabase setup and usage in the Turborepo monorepo.

## Overview

This monorepo uses a **vendor-agnostic database architecture**:

- **Apps** â†’ Import from `@repo/db` (abstraction layer)
- **packages/migrations/** â†’ Vendor-agnostic SQL documentation for communities
- **supabase/** â†’ Your team's local Supabase setup
- **Production** â†’ Can use Supabase OR raw PostgreSQL (or other providers)

### Why This Architecture?

âœ… **For Open Source Communities**: 
- `packages/migrations/` contains portable SQL that works with any PostgreSQL
- No vendor lock-in - communities choose their preferred database
- Documentation guides setup for multiple providers

âœ… **For Your Team**:
- `supabase/` provides convenient local development with Supabase CLI
- Production can use cloud Supabase OR self-hosted Postgres
- Same app code works everywhere (environment variables control provider)

âœ… **For Apps**:
- Import from `@repo/db` - one interface, any backend
- No code changes when switching providers
- TypeScript autocomplete works regardless of database

**Status**: âœ… Setup Complete (requires Docker to start)

---

## Quick Start

### 1. Install Docker

Supabase CLI requires Docker to run local services.

- **macOS/Windows**: [Docker Desktop](https://www.docker.com/products/docker-desktop)
- **Linux**: [Docker Engine](https://docs.docker.com/engine/install/)

### 2. Start Supabase

```bash
cd ~/art/turbo
pnpm dev:infra
```

This starts all Supabase services (PostgreSQL, Auth, Storage, Realtime, REST API, Studio).

### 3. Get Credentials

When you run `pnpm dev:infra`, you'll see:

```
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ”§ Development Tools                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Studio  â”‚ http://127.0.0.1:54323     â”‚
â”‚ Mailpit â”‚ http://127.0.0.1:54324     â”‚
â”‚ MCP     â”‚ http://127.0.0.1:54321/mcp â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸŒ APIs                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Project URL  â”‚ http://127.0.0.1:54321                          â”‚
â”‚ REST API     â”‚ http://127.0.0.1:54321/rest/v1                  â”‚
â”‚ GraphQL      â”‚ http://127.0.0.1:54321/graphql/v1               â”‚
â”‚ Edge Funcs   â”‚ http://127.0.0.1:54321/functions/v1             â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ—„ï¸ Database                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Database URL â”‚ postgresql://postgres:postgres@127.0.0.1:54322/postgres â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ”‘ Authentication                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Publishable  â”‚ sb_publishable_<your_key>                       â”‚
â”‚ Secret       â”‚ sb_secret_<your_key>                            â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ’¾ Storage S3                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Endpoint URL â”‚ http://127.0.0.1:54321/storage/v1/s3            â”‚
â”‚ Access Key   â”‚ <your_access_key>                               â”‚
â”‚ Secret Key   â”‚ <your_secret_key>                               â”‚
â”‚ Region       â”‚ local                                           â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
```

Key services:
- **Studio** (54323): Visual database editor and management UI
- **Mailpit** (54324): Local email testing (catches all emails sent from your app)
- **REST API** (54321): Main API endpoint for database queries
- **GraphQL** (54321): GraphQL endpoint for database queries

### 4. Update Environment Variables

Both apps already have `.env.local` files with Supabase configuration. Update if needed with real credentials from `pnpm dev:infra` output.

**apps/web/.env.local**:
```bash
DB_PROVIDER=supabase
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_<your_key>
SUPABASE_SERVICE_ROLE_KEY=sb_secret_<your_key>
```

**apps/docs/.env.local**:
```bash
DB_PROVIDER=supabase
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_<your_key>
SUPABASE_SERVICE_ROLE_KEY=sb_secret_<your_key>
```

### 5. Run Development

```bash
pnpm dev
```

Both apps now connect to the same Supabase instance.

---

## Architecture

### Directory Structure

```
~/art/turbo/
â”œâ”€â”€ packages/db/                       # Database abstraction layer
â”‚   â”œâ”€â”€ src/index.ts                   # Vendor-agnostic interface
â”‚   â””â”€â”€ README.md                      # Usage guide
â”‚
â”œâ”€â”€ packages/migrations/               # Vendor-agnostic SQL documentation
â”‚   â”œâ”€â”€ migrations/committed/          # Portable SQL migrations
â”‚   â”œâ”€â”€ fixtures/                      # Test data
â”‚   â””â”€â”€ README.md                      # Community guidance
â”‚
â”œâ”€â”€ supabase/                          # Your team's local Supabase setup
â”‚   â”œâ”€â”€ config.toml                    # Supabase-specific config
â”‚   â”œâ”€â”€ migrations/                    # Runtime migrations (synced from packages/migrations)
â”‚   â”œâ”€â”€ seed.sql                       # Development seed data
â”‚   â””â”€â”€ functions/                     # Edge functions (optional)
â”‚
â”œâ”€â”€ apps/web/
â”‚   â””â”€â”€ .env.local                     # DB_PROVIDER=supabase
â”‚
â””â”€â”€ apps/docs/
    â””â”€â”€ .env.local                     # DB_PROVIDER=supabase
```

### Client Code Pattern

Apps use the `@repo/db` abstraction layer instead of directly importing Supabase:

```typescript
// âœ… CORRECT: Use @repo/db abstraction
import { db, dbServer, auth } from '@repo/db';

// Query data
const { data, error } = await db.from('users').select();

// Insert data (server-side)
await dbServer.from('users').insert({ email: 'user@example.com' });

// Authentication
const { data: { session } } = await auth.getSession();
```

```typescript
// âŒ AVOID: Direct vendor imports (creates lock-in)
import { createClient } from '@supabase/supabase-js';
const supabase = createClient(url, key);
```

**Why?**
- Same code works with Supabase, raw PostgreSQL, or other providers
- Switch providers by changing environment variables only
- No code changes in apps when migrating databases
- Community members can use any database they prefer

### Region Support

**Single database, region-aware via Row-Level Security (RLS):**

```sql
-- Add region column to tables
ALTER TABLE users ADD COLUMN region_id TEXT;

-- RLS policy for region isolation
CREATE POLICY "Region isolation" ON users
  FOR SELECT
  USING (region_id = current_setting('app.region_id'));
```

**No multiple instances, no per-region databases.**

---

## Available Commands

```bash
# Start Supabase infrastructure
pnpm dev:infra

# Reset database (drop â†’ migrate â†’ seed)
pnpm db:reset

# Stop Supabase
pnpm db:stop

# Check status and credentials
pnpm exec supabase status

# Access Supabase Studio
# http://127.0.0.1:54323

# Run all apps
pnpm dev
```

---

## Database Migrations

### Workflow

1. **Create migration**:
   ```bash
   pnpm exec supabase migration new create_users_table
   ```

2. **Edit migration** in `supabase/migrations/<timestamp>_create_users_table.sql`:
   ```sql
   CREATE TABLE IF NOT EXISTS public.users (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     email TEXT UNIQUE NOT NULL,
     region_id TEXT NOT NULL,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
   );

   ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

   CREATE POLICY "Users can view own data"
     ON public.users FOR SELECT
     USING (auth.uid() = id);
   ```

3. **Test migration**:
   ```bash
   pnpm db:reset
   ```

4. **Sync to documentation**:
   ```bash
   cp supabase/migrations/*.sql packages/migrations/migrations/committed/
   ```

5. **Document** in `packages/migrations/README.md`

### Migration Strategy

- **`supabase/migrations/`**: Runtime execution (Supabase CLI runs these)
- **`packages/migrations/`**: Source of truth (documentation, testing, fixtures)
- **Sync**: Manual copy or git pre-commit hook

### Best Practices

âœ… Use `IF NOT EXISTS` / `IF EXISTS` (idempotent)  
âœ… Keep migrations small and focused  
âœ… Test with `pnpm db:reset` before committing  
âœ… Include RLS policies with new tables  
âœ… Document intent in `packages/migrations/README.md`  

âŒ No manual schema changes (always use migrations)  
âŒ No multiple Supabase instances  
âŒ No hardcoded region logic in migrations  

---

## Common Tasks

### View Database Schema

```bash
pnpm exec supabase db dump --schema=public > schema.sql
```

### Access Database Directly

```bash
psql postgresql://postgres:postgres@127.0.0.1:54322/postgres
```

### Reset Everything

```bash
pnpm exec supabase stop --no-backup
pnpm dev:infra
```

### Validate Setup

```bash
bash scripts/validate-supabase.sh
```

---

## Troubleshooting

### Docker Not Running

```
Error: Cannot connect to the Docker daemon
```

**Solution**: Start Docker Desktop or Docker Engine and retry.

### Port Already in Use

If ports `54320-54324` are occupied, edit `supabase/config.toml`:

```toml
[db]
port = 54322

[api]
port = 54321

[studio]
port = 54323
```

Then restart:
```bash
pnpm exec supabase stop
pnpm dev:infra
```

### Wrong Supabase URL

If you get "Invalid supabaseUrl" error, ensure `.env.local` has the **Project URL** (not Database URL):

```bash
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
```

**Not** the database URL (`postgresql://...`).

### Missing Credentials

Run `pnpm dev:infra` and copy the **Publishable** and **Secret** keys to your `.env.local` files:

```bash
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_<your_key>
SUPABASE_SERVICE_ROLE_KEY=sb_secret_<your_key>
```

### Connection Failed

Ensure Supabase is running:
```bash
pnpm exec supabase status
```

If not running:
```bash
pnpm dev:infra
```

---

## Production Deployment

This setup supports **multiple deployment options** with the same codebase:

### Option 1: Cloud Supabase (Managed)

1. **Create Supabase project** at [supabase.com](https://supabase.com)
2. **Set environment variables**:
   ```bash
   DB_PROVIDER=supabase
   NEXT_PUBLIC_SUPABASE_URL=https://<project>.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=<project_anon_key>
   SUPABASE_SERVICE_ROLE_KEY=<project_service_key>
   ```
3. **Deploy apps** (no code changes)
4. **Run migrations** via Supabase Dashboard or CLI

### Option 2: Self-Hosted PostgreSQL

1. **Deploy PostgreSQL** (AWS RDS, Neon, Railway, etc.)
2. **Set environment variables**:
   ```bash
   DB_PROVIDER=postgres
   DATABASE_URL=postgresql://user:password@host:5432/dbname
   ```
3. **Deploy apps** (no code changes)
4. **Run migrations** from `packages/migrations/`

**Note**: PostgreSQL provider is currently TODO in `@repo/db`. For now, use Supabase.

### Option 3: Community Self-Hosting

Community members can:
1. Use `packages/migrations/` SQL files (vendor-agnostic)
2. Set up any PostgreSQL-compatible database
3. Configure `DB_PROVIDER` and connection credentials
4. Same app code works without modification

---

## Security Notes

- âœ… `.env.local` files in `.gitignore` (not committed)
- âœ… Service role key is environment variable only (never hardcoded)
- âœ… Same code everywhere (no environment branching)
- âœ… RLS policies enforce data isolation
- âš ï¸ Local development keys are for development only
- âš ï¸ Never expose `SUPABASE_SERVICE_ROLE_KEY` in client code

---

## Non-Goals (Explicitly Avoided)

| Non-Goal | Reason |
|----------|--------|
| âŒ Docker Compose for Supabase | Use `pnpm dev:infra` instead |
| âŒ Cloud Supabase for local dev | Local only |
| âŒ Multiple Supabase instances | One shared instance |
| âŒ Per-app databases | All apps share same DB |
| âŒ Per-region Supabase instances | Use RLS + `region_id` |
| âŒ Environment-based code branching | Same code everywhere |

---

## Implementation Details

### What Was Set Up

âœ… **Supabase CLI** installed (v2.72.8) as workspace devDependency  
âœ… **Single project** at `supabase/` (monorepo root)  
âœ… **Environment variables** configured in both apps  
âœ… **Client code** in `apps/web/lib/supabase-client.ts` and `apps/docs/lib/supabase-client.ts`  
âœ… **Migration strategy** documented (supabase/migrations/ â†” packages/migrations/)  
âœ… **NPM scripts** added (`dev:infra`, `db:reset`, `db:stop`)  
âœ… **Validation script** at `scripts/validate-supabase.sh`  
âœ… **Documentation** complete  

### Files Created

```
packages/db/                          # New: Database abstraction layer
â”œâ”€â”€ src/index.ts
â”œâ”€â”€ package.json
â””â”€â”€ README.md

supabase/
â”œâ”€â”€ config.toml
â”œâ”€â”€ migrations/
â”œâ”€â”€ seed.sql
â””â”€â”€ functions/

apps/web/
â””â”€â”€ .env.local (updated with DB_PROVIDER)

apps/docs/
â”œâ”€â”€ .env.local (updated with DB_PROVIDER)
â””â”€â”€ .env.local.example

scripts/
â””â”€â”€ validate-supabase.sh
```

### Dependencies Added

- `@repo/db` (new shared package)
- `@supabase/supabase-js` (in `@repo/db` only, not in apps)
- Apps import from `@repo/db` (abstraction layer)

### Environment Variables Required

| Variable | Scope | Purpose |
|----------|-------|---------|
| `DB_PROVIDER` | All | Database provider (`supabase` or `postgres`) |
| `NEXT_PUBLIC_SUPABASE_URL` | Client | Supabase API URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Client | Supabase public anon key |
| `SUPABASE_SERVICE_ROLE_KEY` | Server | Supabase admin key (server-side only) |
| `DATABASE_URL` | Server | PostgreSQL connection string (when `DB_PROVIDER=postgres`) |

---

## Validation Checklist

Run anytime:
```bash
bash scripts/validate-supabase.sh
```

Expected output:
```
âœ“ supabase/ exists
âœ“ supabase/config.toml exists
âœ“ supabase/migrations/ exists
âœ“ Supabase CLI installed
âœ“ @supabase/supabase-js in apps/web
âœ“ @supabase/supabase-js in apps/docs
âœ“ apps/web/.env.local exists
âœ“ apps/docs/.env.local exists
âœ“ Client files exist
âœ“ NPM scripts configured
```

---

## Next Steps

1. **Install Docker** (if not installed)
2. **Start Supabase**: `pnpm dev:infra`
3. **Create migrations**: `pnpm exec supabase migration new <name>`
4. **Add RLS policies** for auth and region isolation
5. **Seed data** in `supabase/seed.sql`
6. **Start building** ğŸš€

---

## Reference Links

- **[@repo/db README](../../../packages/db/README.md)** - Database abstraction layer usage
- **[packages/migrations README](../../../packages/migrations/README.md)** - Vendor-agnostic migrations
- [Supabase Local Development Docs](https://supabase.com/docs/guides/local-development)
- [Supabase CLI Reference](https://supabase.com/docs/reference/cli)
- [Row Level Security Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Migrations Best Practices](https://supabase.com/docs/guides/local-development/migrations)

---

**Questions?** Run `bash scripts/validate-supabase.sh` to verify setup or check Supabase status with `pnpm exec supabase status`.
